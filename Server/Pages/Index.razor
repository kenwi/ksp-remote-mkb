@page "/"
@using Grpc.Net.Client
@using Microsoft.AspNetCore.Components.Web
@using Blazor.Extensions.Canvas
@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.PixelFormats
@using Server.Services

@inject ScreenshotService ScreenshotService

<PageTitle>Index</PageTitle>
<img src="@Image64" width="1600" height="900" @onmousedown="@MouseClick" @onmouseup="@MouseUp" @onmousemove="@MouseMove" />

@code
{
    Remote.RemoteClient? client;
    MouseEvent? outboundEvent = new();
    protected string Image64 { get; set; } = string.Empty;
    Random rng = new Random();
    Resolution monitor = new();
    DateTime last = new();
    ScreenCapture sc = new();
    float xmod = 0, ymod = 0;

    async void RunPeriodicImageUpdate()
    {
        while (true)
        {
            Image64 = ScreenshotService.Image64;
            StateHasChanged();
            await Task.Delay(100);
        }
    }

    protected override void OnInitialized()
    {
        try
        {
            var identification = new Identification() { Id = Guid.Empty.ToString() };
            var rpcEndpoint = "https://localhost";
            var channel = GrpcChannel.ForAddress(rpcEndpoint, new GrpcChannelOptions
                {
                    HttpHandler = new HttpClientHandler
                    {
                        ServerCertificateCustomValidationCallback = HttpClientHandler.DangerousAcceptAnyServerCertificateValidator
                    }
                });
            client = new Remote.RemoteClient(channel);
            monitor = client.GetMonitorResolution(new Empty());

            RunPeriodicImageUpdate();
        }
        catch (Exception)
        {
            client = null;
            throw;
        }

        base.OnInitialized();
    }

    void CalculateRatio()
    {
        xmod = (float)monitor.X / 1600;
        ymod = (float)monitor.Y / 900;
    }

    protected async void MouseUp(MouseEventArgs e)
    {
        if ((DateTime.Now - last).Milliseconds < 100)
            return;
        if (outboundEvent == null || client == null)
            return;

        CalculateRatio();
        outboundEvent.X = (int)(e.ClientX * xmod) - 50;
        outboundEvent.Y = (int)(e.ClientY * ymod) - 25;
        outboundEvent.Type = EventType.Leftup;
        await client.SendMouseEventAsync(outboundEvent);
    }

    protected async void MouseClick(MouseEventArgs e)
    {
        if ((DateTime.Now - last).Milliseconds < 100)
            return;
        if (outboundEvent == null || client == null)
            return;

        CalculateRatio();
        outboundEvent.X = (int)(e.ClientX * xmod) - 50;
        outboundEvent.Y = (int)(e.ClientY * ymod) - 25;
        outboundEvent.Type = EventType.Leftdown;
        await client.SendMouseEventAsync(outboundEvent);
    }

    protected async void MouseMove(MouseEventArgs e)
    {
        if ((DateTime.Now - last).Milliseconds < 10)
            return;
        if (outboundEvent == null || client == null)
            return;

        CalculateRatio();
        outboundEvent.X = (int)(e.ClientX * xmod) - 50;
        outboundEvent.Y = (int)(e.ClientY * ymod) - 25;
        outboundEvent.Type = EventType.Move;
        await client.SendMouseEventAsync(outboundEvent);
    }
}
